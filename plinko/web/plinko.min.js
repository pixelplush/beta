let e="Pixel Plinko",t={},a={},o="",n=1920,i=1080,s=.5;function r(e){return Math.floor(Math.random()*Math.floor(e))}window.setupGame=function(r,l,c){e=r,t=l,a=c,o=t.path||"",a.clouds=void 0===a.clouds||null===a.clouds?!a.overlay:a.clouds,s=void 0===a.volume||null===a.volume?0:parseInt(a.volume)/100,n=Math.min(window.innerWidth,1920),i=Math.min(window.innerHeight,1080)},window.WebFontConfig={custom:{families:["Pixeltype"]},active(){!function(){try{a.cpPlink&&(d["Plinko!"]={desc:"Drop into the PixelPlush Plinko Game!",color:"#F2C079",cost:parseInt(a.cpPlinkCost||50),callback:(e,t,o,n,i)=>{h&&a.hideTilStart&&(h=!1,x.forEach(e=>e.visible=!0),v.forEach(e=>e.sprite.visible=!0),w.forEach(e=>e.sprite.visible=!0),S.visible=!0,$&&($.visible=!0)),E(i.username,e,i.userColor||"#ffffff",n,i.messageEmotes?Object.keys(i.messageEmotes)[0]:"")}})}catch(e){console.log(e)}Unicorn.Create("unicorn-display",{width:n,height:i,background:"transparent",init:U,update:k,channel:a.channel,username:a.oauth?a.channel:void 0,password:a.oauth.replace("oauth:",""),onCommand:m,onChat:y,wallBottom:!0,gravity:{x:0,y:1}}),ComfyJS.onConnected=async(e,o,i)=>{if(i){!function(){if(a.clouds)for(let e=0;e<11;e++){f++;let e=t.clouds[r(t.clouds.length)],o=Unicorn.AddOverlay("cloud_"+f,e,r(n),r(500),{scale:{x:3,y:3}});o.alpha=a.overlay?.5:.9,o.anchor.set(.5),o.speed=.01+.1*Math.random(),o.zIndex=o.speed,x.push(o)}a.hideTilStart&&(x.forEach(e=>e.visible=!1),v.forEach(e=>e.sprite.visible=!1),w.forEach(e=>e.sprite.visible=!1),S.visible=!1,$&&($.visible=!1))}();let e=await p();if(0!==e&&(l=e.session,setInterval(()=>{p()},6e4)),a.oauth){let e=await async function(e){return await fetch("https://id.twitch.tv/oauth2/validate",{headers:{Authorization:`OAuth ${e}`}}).then(e=>e.json()).catch(e=>({error:e}))}(a.oauth.replace("oauth:",""));console.log(e),c=e.client_id,["user:read:email","chat:read","chat:edit","channel:manage:redemptions","channel:read:redemptions"].every(t=>e.scopes.includes(t))||console.log("Need more permissions"),e.expires_in<1800&&console.log("Token expires soon. Need to generate new link")}let o=[];try{o=await ComfyJS.GetChannelRewards(c,!0)}catch(e){console.log(e)}let i=Object.keys(d);console.log(d);for(let e=0;e<i.length;e++){let t=i[e];o.some(e=>e.title===t)||await ComfyJS.CreateChannelReward(c,{title:t,prompt:d[t].desc,cost:d[t].cost,is_enabled:!0,background_color:d[t].color,is_user_input_required:!1,is_max_per_stream_enabled:!1,max_per_stream:0,is_max_per_user_per_stream_enabled:!1,max_per_user_per_stream:0,is_global_cooldown_enabled:!!d[t].cooldown,global_cooldown_seconds:d[t].cooldown,should_redemptions_skip_request_queue:!0})}}ComfyJS.onReward=(e,t,a,o,n)=>{d[t]&&d[t].callback(e,t,a,o,n)}}}()}},function(){const e=document.createElement("script");e.src=`${"https:"===document.location.protocol?"https":"http"}://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js`,e.type="text/javascript",e.async="true";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();var l="";let c="";const d={};async function p(){let t=Object.keys(g).length;return fetch("https://api.pixelplush.dev/v1/analytics/heartbeat",{method:"POST",body:JSON.stringify({session:l,game:"plinko",theme:e,channel:a.channel,players:Object.keys(g),count:t})}).then(e=>e.json())}let f=0,h=!0;async function m(e,o,n,i,s){if(!i.broadcaster&&!i.mod||"resetplinko"!==o&&"resetboing"!==o||location.reload(),(i.broadcaster||i.mod)&&("deleteplinko"===o||"deleteboing"===o)){let e=await ComfyJS.GetChannelRewards(c,!0),t=Object.keys(d);for(let a=0;a<t.length;a++){let o=t[a],n=e.find(e=>e.title===o);n&&await ComfyJS.DeleteChannelReward(c,n.id)}}if((i.broadcaster||i.mod)&&"testplinko"===o)for(var l=0;l<50;l++)f++,E("test"+f,"test_"+f,s.userColor||"#ffffff",Object.keys(t.characters)[r(Object.keys(t.characters).length)]);if("plink"===o||"plinko"===o||"boing"===o||"boingboing"===o){h&&a.hideTilStart&&(h=!1,x.forEach(e=>e.visible=!0),v.forEach(e=>e.sprite.visible=!0),w.forEach(e=>e.sprite.visible=!0),S.visible=!0,$&&($.visible=!0));const t=twemoji.parse(n,{assetType:"png"});!s.messageEmotes&&t.length>0?E(s.username,e,s.userColor||"#ffffff",n,"",t[0].url):E(s.username,e,s.userColor||"#ffffff",n,s.messageEmotes?Object.keys(s.messageEmotes)[0]:"")}}function y(e,t,a,o,n){}let u=null,g={},b={},_={},x=[],v=[],w=[],$=null,S=null;async function E(e,i,l="#ffffff",c,d="",p=""){if(!g[e]){g[e]={};let m=null,y=null,x=null,v=tinycolor(l),w={};try{let t=await fetch(`https://api.pixelplush.dev/v1/accounts/twitch/design?username=${e}`).then(e=>e.json());t&&(w=t.style||{})}catch(e){console.log(e)}if(w.pet&&w.pet.id&&"pet_none"!==w.pet.id&&(t.pets||(t.pets={}),y=w.pet.id.replace("pet_",""),!t.pets[y])){t.pets[y]={path:w.pet.path,minIdle:w.pet.minIdle,maxIdle:w.pet.maxIdle};for(let e=0;e<10;e++){let t=w.pet.path+"_front";Unicorn.Load(t+e,`${o}/assets/pets/${y}/${t}/${t}${e+1}.png`)}}if(d){if(!b[d]){b[d]=!0;var f=`https://static-cdn.jtvnw.net/emoticons/v1/${d}/2.0`;return Unicorn.Load(`emote_${d}`,f),void setTimeout(()=>{delete g[e],E(e,i,l,c,d,p)},500)}m=Unicorn.AddObject("player_"+e,{type:"circle",scale:{x:1.2,y:1.2},animations:{front:{framerate:4/60,frames:[`emote_${d}`],loop:!0}},x:200+r(n-400),y:-100-r(50),z:100,radius:36,onEnter:(t,o)=>{if("bottom_detect"===t&&(g[e].isLanded=!0,m.isSensor=!0,m.isStatic=!0,1*n/5+n/5-8<m.position.x&&m.position.x<2*n/5+n/5-8&&(console.log("Winner: "+e),Unicorn.PlaySound("sfx-win",{volume:s}),a.messageFormat))){let t=a.messageFormat.replace("USERNAME",e);setTimeout(()=>{ComfyJS.Say(t)},5e3)}}}),m.endImage=`emote_${d}`,m.endScale=1.2}else if(p){if(!_[p])return _[p]=!0,Unicorn.Load(`emoji_${p}`,p),void setTimeout(()=>{delete g[e],E(e,i,l,c,d,p)},500);m=Unicorn.AddObject("player_"+e,{type:"circle",scale:{x:1,y:1},animations:{front:{framerate:4/60,frames:[`emoji_${p}`],loop:!0}},x:200+r(n-400),y:-100-r(50),z:100,radius:36,onEnter:(t,o)=>{if("bottom_detect"===t&&(g[e].isLanded=!0,m.isSensor=!0,m.isStatic=!0,1*n/5+n/5-8<m.position.x&&m.position.x<2*n/5+n/5-8&&(console.log("Winner: "+e),Unicorn.PlaySound("sfx-win",{volume:s}),a.messageFormat))){let t=a.messageFormat.replace("USERNAME",e);setTimeout(()=>{ComfyJS.Say(t)},5e3)}}}),m.endImage=`emoji_${p}`,m.endScale=1}else{if(!t.characters[c])if(w.character&&w.character.id){if(!t.characters[w.character.id]){t.characters[w.character.id]=w.character.path;for(let e=0;e<10;e++){let a=t.characters[w.character.id];Unicorn.Load(`${w.character.id}_${e}`,`${o}/assets/characters/${w.character.id}/${a}_front/${a}_front${e+1}.png`)}}c=w.character.id}else c=t.playable[Math.floor(t.playable.length*Math.random())];if(m=Unicorn.AddObject("player_"+e,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:4/60,frames:[...Array(10).keys()].map(e=>`${c}_${e}`),loop:!0}},x:200+r(n-400),y:-100-r(50),z:100,radius:36,onEnter:(t,o)=>{if("bottom_detect"===t&&(g[e].isLanded=!0,m.isSensor=!0,m.isStatic=!0,1*n/5+n/5-8<m.position.x&&m.position.x<2*n/5+n/5-8&&(console.log("Winner: "+e),Unicorn.PlaySound("sfx-win",{volume:s}),a.messageFormat))){let t=a.messageFormat.replace("USERNAME",e);setTimeout(()=>{ComfyJS.Say(t)},5e3)}}}),m.endImage=`${c}_0`,m.endScale=3,"boybear"===c||"girlbear"===c){var h=PIXI.utils.string2hex(v.brighten(50).toHexString());m.animations.front.tint=h}if(y){let a={front:[]};for(let e=0;e<10;e++)Object.keys(a).forEach(o=>{a[o].push(t.pets[y].path+"_"+o+e)});x=Unicorn.AddObject("pet_"+e,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:4/60,frames:a.front,loop:!0}},x:-1e3,y:-1e3,z:200,radius:24,isStatic:!0}),x.isSensor=!0}}let $=Unicorn.AddText("name_"+e,i,-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:l,lineJoin:"round",stroke:v.getLuminance()<.6?"#ffffff":"#000000",strokeThickness:6});$.anchor.set(.5),m.rotationOffset=Math.random()*Math.PI,g[e]={player:m,label:$,pet:x,petType:y,petOffset:50*Math.random()-25},u&&clearTimeout(u),u=setTimeout(()=>{location.reload()},9e4)}}function U(){if(PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,Unicorn.Load("map",`${o}/assets/${t.bg}.png`),!a.overlay){var e=Unicorn.AddBacklay("map","map",0,i-1080);e.scale.x=3,e.scale.y=3}t.wall&&Unicorn.Load("wall",`${o}/assets/${t.wall}.png`),t.wallfront&&Unicorn.Load("wallfront",`${o}/assets/${t.wallfront}.png`),Array.isArray(t.peg)?t.peg.forEach((e,t)=>{Unicorn.Load("peg"+t,`${o}/assets/${e}.png`)}):Unicorn.Load("peg",`${o}/assets/${t.peg}.png`),Unicorn.Load("star",`${o}/assets/${t.star}.png`),Object.keys(t.characters).forEach(e=>{for(let a=0;a<10;a++){let n=t.characters[e];Unicorn.Load(`${e}_${a}`,`${o}/assets/characters/${e}/${n}_front/${n}_front${a+1}.png`)}}),t.clouds.forEach(e=>Unicorn.Load(e,`${o}/assets/${e}.png`)),Unicorn.Load("sfx-peg-bounce",`${o}/assets/${t.peg_sound}`),Unicorn.Load("sfx-win",`${o}/assets/${t.win_sound}`);for(let e=0;e<4;e++){let o,r,l;e%2==0?(o=Math.floor(n/137),r=n/o,l=r,o--):(o=Math.floor((n-137)/137),o--,r=137,l=137+r/2);for(let n=0;n<o;n++){let o="peg";Array.isArray(t.peg)&&(o="peg"+(n+2*e)%t.peg.length);let c=Unicorn.AddObject(`peg_${e}-${n}`,{type:"circle",x:n*r+l,y:i-240-200*e,radius:27,scale:{x:3,y:3},sprite:o,isStatic:!0,density:1/0,friction:1,frictionStatic:.5,frictionAir:.01,onEnter:(e,t)=>{e.startsWith("player_")&&Unicorn.PlaySound("sfx-peg-bounce",{volume:s})}});c.sprite.alpha=a.overlay?.15:1,c.restitution=1.05,c.mass=1/0,c.inverseMass=0,v.push(c)}}for(let e=0;e<4;e++){let t=Unicorn.AddObject(`wall_${e}`,{type:"rectangle",x:e*n/5+n/5-8,y:i-60,width:12,height:120,scale:{x:3,y:3},sprite:"wall",isStatic:!0});w.push(t)}t.wallfront&&($=Unicorn.AddBacklay("wallfront","wallfront",0,i-1080),$.scale.x=n/1920*3,$.scale.y=3),Unicorn.AddObject("bottom_detect",{type:"rectangle",x:n/2,y:i-2,width:n,height:2,isStatic:!0,isSensor:!0}).sprite.visible=!1;let r=Unicorn.AddObject("left_bound",{type:"rectangle",x:-100,y:i/2,width:200,height:i,isStatic:!0});r.restitution=1.05,r.mass=1/0,r.inverseMass=0,r.sprite.visible=!1;let l=Unicorn.AddObject("right_bound",{type:"rectangle",x:n+100,y:i/2,width:200,height:i,isStatic:!0});l.restitution=1.05,l.mass=1/0,l.inverseMass=0,l.sprite.visible=!1,S=Unicorn.AddBacklay("star","star",n/2,i-80,{scale:{x:3,y:3}}),S.anchor.set(.5),Matter.Events.on(physics,"beforeUpdate",(function(e){for(var t in g)g[t].player&&Matter.Body.setVelocity(g[t].player,{x:Math.max(Math.min(g[t].player.velocity.x,30),-30),y:Math.max(Math.min(g[t].player.velocity.y,30),-30)})}))}function k(e,t){for(var a in g)g[a].player&&(g[a].isLanded,g[a].label.position.x=g[a].player.position.x,g[a].label.position.y=g[a].player.position.y-60,g[a].pet&&(g[a].pet.angle=g[a].player.angle,g[a].pet.position.x=Math.max(20,Math.min(n-20,g[a].player.position.x+g[a].petOffset)),g[a].pet.position.y=g[a].player.position.y+20));x.forEach((e,a)=>{e.x-=t*e.speed,e.x+e.width/2<=0&&(e.x=n+e.width/2,e.y=r(500),e.speed=.01+.1*Math.random(),e.zIndex=e.speed)})}